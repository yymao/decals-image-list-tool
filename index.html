<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>DECaLS Image List Tool</title>
  <link rel="stylesheet" href="https://unpkg.com/purecss@1.0.0/build/pure-min.css">
  <style>
  #main{
    padding: 0.5em;
    max-width: 1000px;
    margin-left: auto;
    margin-right: auto;
    margin-bottom: 200px;
  }
  #form{
    max-width: 800px;
    margin-left: auto;
    margin-right: auto;
  }
  #input{
    width:100%;
    height: 100px;
  }
  #scale_unit, #layer{
    height: 2.5em;
  }
  #scale{
    width: 4em;
  }
  #list{
    width: 100%;
  }
  .optiongroup{
    margin-right: 25px;
  }
  .credit{
    font-size: 80%;
  }
  .picture{
    margin: 4px;
    border: solid 6px #FFF;
    width:180px;
    height:180px;
    display: inline-block;
    transform-origin: center;
  }
  .marked{
    border: solid 6px #0078e7;
  }
  .r1 {transform: rotate(90deg);}
  .r2 {transform: rotate(180deg);}
  .r3 {transform: rotate(270deg);}
  .r0f {transform: scaleX(-1);}
  .r1f {transform: rotate(90deg) scaleX(-1);}
  .r2f {transform: rotate(180deg) scaleX(-1);}
  .r3f {transform: rotate(270deg) scaleX(-1);}
  </style>
</head>

<body>
<div id="main">
<div id="form">
<center>
<form class="pure-form">
  <fieldset>
    <p><textarea id="input" placeholder="a list of RA ad Dec">name        ra     dec
274-51913-230 159.815 -0.655
275-51910-275 161.051  0.152
275-51910-525 161.739  0.893
276-51909-19  164.090 -0.889
278-51900-39  168.470  0.004
278-51900-112 168.092 -0.255
278-51900-225 167.091 -0.216
278-51900-430 167.114  0.249
279-51984-456 168.956  0.860
279-51984-520 169.472 -0.007
281-51614-230 171.109 -0.427
282-51658-167 173.898 -0.585
285-51930-309 178.908 -0.771
286-51999-359 180.271  0.114
288-52000-173 184.837 -0.242
349-51699-582 255.537 64.206
353-51703-328 255.737 60.563
353-51703-365 256.157 60.585
355-51788-167 258.984 57.238
355-51788-563 260.121 58.797
358-51818-349 260.930 57.007
387-51791-72    0.744  0.142
389-51795-481   3.874  0.640
390-51900-196   5.183 -0.440
390-51900-464   5.432  0.296</textarea></p>
    <p>
    <select id="layer" class="optiongroup">
      <option disabled selected value style="display: none;"> -- Select a layer -- </option>
      <option value="decals-dr3" id="default-layer">DECaLS DR3</option>
      <option value="decals-dr3-model">DECaLS DR3 Model</option>
      <option value="decals-dr3-resid">DECaLS DR3 Residual</option>
      <option value="mzls+bass-dr4">MzLS+BASS DR4</option>
      <option value="mzls+bass-dr4-model">MzLS+BASS DR4 Model</option>
      <option value="mzls+bass-dr4-resid">MzLS+BASS DR4 Residual</option>
      <option value="sdssco">SDSS</option>
      <option value="unwise-neo2">unWISE NEO2</option>
      <option value="unwise-w1w2">unWISE</option>
<!--      <option value="decals-dr2">DECaLS DR2</option>
      <option value="decals-dr2-model">DECaLS DR2 Model</option>
      <option value="decals-dr2-resid">DECaLS DR2 Residual</option>-->
    </select>
    <span class="optiongroup">
      <input type="text" id="scale" value="0.25">
      <select id="scale_unit">
        <option value="pixscale" selected>"/pix</option>
        <option value="zoom">zoom</option>
      </select>
    </span>
    <span class="optiongroup">
      <input type="checkbox" id="enable_marking"/>Enable marking
    </span>
    <button id="generate_output" class="pure-button" disabled>Record marks</button>
    </p>
    <p class="credit">Cutout images are from the <a href="http://legacysurvey.org/">Dark Energy Camera Legacy Survey</a>. <a href="https://github.com/yymao/decals-image-list-tool">Web interface</a> by <a href="https://yymao.github.io">Yao-Yuan Mao</a>.</p>
  </fieldset>

</form>
</center>
</div>
<div id="list"></div>
</div>

<script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
<script>
var _cols, _i_ra, _i_dec, _has_mark, _delimiter, _scale, _scale_unit, _layer;
var _output_img_temp = "<img class='picture ${marked} ${rot}' title='${title}' src='http://legacysurvey.org/viewer-dev/jpeg-cutout/?ra=${ra}&dec=${dec}&${scale_unit}=${scale}&layer=${layer}&size=180'>";
//var _output_img_temp = "<span title='${title}' class='picture ${marked} ${rot}'>${ra}<br>${dec}<br>layer=${layer}<br>${scale_unit}=${scale}</span>";
var _output_link_temp = "<a href='http://skyserver.sdss.org/dr13/en/tools/chart/navi.aspx?ra=${ra}&dec=${dec}'>${img}</a>";
var _do_rand_rot = (window.location.hash.substr(1) == "randrot");
var _rot_classes = ["", "r1", "r2", "r3", "r0f", "r1f", "r2f", "r3f"];

function parseHeader(line){
  var line = line.trim().toLowerCase();
  var has_header = true;

  _delimiter = /\s+/;
  if (line.search(",") > -1) _delimiter = ",";
  _cols = line.split(_delimiter);

  _i_ra = _cols.indexOf("ra");
  _i_dec = _cols.indexOf("dec");

  if (_i_ra == -1 || _i_dec == -1){ // no header
    if (_cols[_cols.length-1] == "true" || _cols[_cols.length-1] == "false"){
      _has_mark = true;
      _cols.pop();
    }
    if (_cols.length == 2){
      _i_ra = 0;
      _i_dec = 1;
    }
    else if (_cols.length > 2){
      _i_ra = 1;
      _i_dec = 2;
    }
    else{
      _has_mark = false;
      $("#list").html("<p>Error! \nPlease make sure the first line is header, and it contains at least \"ra\" and \"dec\". \nOnly supports space/tab/comma-separated tables.</p>");
      return -1;
    }
    _cols = _cols.fill("");
    has_header = false;
  }
  else{ // has header
    if (_cols[_cols.length-1] == "marked"){
      _has_mark = true;
      _cols.pop();
    }
  }
  return has_header;
}

function addImage(line) {
  var items, output, mark;
  items = line.trim().split(_delimiter);
  if (_has_mark) mark = (items.pop()=="true");
  output = _output_img_temp;
  if (!$("#enable_marking").prop("checked")){
    output = _output_link_temp.replace(/\${img}/g, _output_img_temp);
  }
  output = output.replace(/\${ra}/g, items[_i_ra]);
  output = output.replace(/\${dec}/g, items[_i_dec]);
  output = output.replace("${scale_unit}", _scale_unit);
  output = output.replace("${scale}", _scale);
  output = output.replace("${layer}", _layer);
  output = output.replace("${title}", items.map(function(item, i, arr){return _cols[i] + " = " + item;}).join("\n"));
  output = output.replace("${marked}", mark? "marked" : "");
  output = output.replace("${rot}", _do_rand_rot? _rot_classes[Math.floor(Math.random()*_rot_classes.length)] : "");
  $("#list").append(output);
}

function run(){
  var new_layer = $("#layer").val();
  var new_scale = $("#scale").val();
  var new_scale_unit = $("#scale_unit").val();

  if (!_layer){
    if (!new_layer){
      new_layer = $("#default-layer").attr("value");
      $("#default-layer").prop("selected", true);
    }
    _layer = new_layer;
  }

  if (!_scale) _scale = new_scale;
  if (!_scale_unit) _scale_unit = new_scale_unit;

  if (new_layer != _layer && _scale_unit == "zoom"){
    if (_layer != "sdssco" && new_layer == "sdssco"){
      new_scale = (parseInt(_scale) - 1).toString();
    }
    else if (_layer == "sdssco" && new_layer != "sdssco"){
      new_scale = (parseInt(_scale) + 1).toString();
    }
  }

  if (new_scale_unit != _scale_unit){
    if (new_scale_unit == "zoom"){
      new_scale = "14";
    }
    else {
      new_scale = "0.25";
    }
  }

  if ($("#list").html()){
    $(".picture").each(function(){
      var url = $(this).attr("src");
      //var url = $(this).html();
      if (_layer != new_layer) url = url.replace("layer="+_layer, "layer="+new_layer);
      if (_scale_unit != new_scale_unit || _scale != new_scale) url = url.replace(_scale_unit+"="+_scale, new_scale_unit+"="+new_scale);
      $(this).attr("src", url);
      //$(this).html(url);
    });
  }
  else{
    var lines = $("#input").val().split(/\n/);
    var has_header = parseHeader(lines[0]);
    if (has_header == -1) return;
    if (has_header) lines.shift();
    lines.forEach(addImage);

    if ($("#enable_marking").prop("checked")){
      $(".picture").click(function(){
        $(this).toggleClass("marked");
        $("#generate_output").prop("disabled", false);
      });
      $("#input").prop("readonly", true);
      $("#generate_output").addClass("pure-button-primary");
    }
    else{
      $("#input").prop("readonly", false);
      $("#generate_output").removeClass("pure-button-primary");
      $("#generate_output").prop("disabled", true);
    }
  }

  if (new_scale != _scale) $("#scale").val(new_scale);
  _layer = new_layer;
  _scale = new_scale;
  _scale_unit = new_scale_unit;
}

function new_run(){
  if (!$("#generate_output").prop("disabled") &&
      !window.confirm("Are you sure you want to reload the images? You cannot recover the marks you made!")){
    $("#enable_marking").prop("checked", !$("#enable_marking").prop("checked"));
    return;
  }
  $("#list").empty();
  run();
}

function output(){
  var out = "";
  out += _cols.join("\t");
  out += "\tmarked\n";
  if (out.trim() == "marked") out = "";
  out += $(".picture").map(function(){
    return $(this).attr("title").split(/\n/).map(function(item){
      return item.substring(item.indexOf(" = ")+3);
    }).join("\t") + "\t" + $(this).hasClass("marked");
  }).get().join("\n");
  $("#input").val(out);
  $("#generate_output").prop("disabled", true);
}

$("form").submit(function(event){event.preventDefault();});
$("#generate_output").click(output);
$("#layer").change(run);
$("#scale").change(run);
$("#scale_unit").change(run);
$("#input").change(function(){
  $("#list").empty();
  run();
});
$("#enable_marking").change(function(){
  if (!$("#generate_output").prop("disabled") &&
      !window.confirm("Are you sure you want to reload the images? You cannot recover the marks you made!")){
    $("#enable_marking").prop("checked", !$("#enable_marking").prop("checked"));
    return;
  }
  $("#list").empty();
  run();
});

$(window).on("beforeunload", function () {
  if (!$("#generate_output").prop("disabled")){
    return "Are you sure you want to close this page? You cannot recover the marks you made!";
  }
});

</script>
</body>
</html>
